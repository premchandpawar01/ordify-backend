<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Order Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #aaa;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container">

        <div id="selection-view" class="view active">
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto mt-16">
                <h1 class="text-3xl font-bold text-slate-800 text-center mb-2">Client Order Portal</h1>
                <p class="text-slate-500 text-center mb-8">Please select your company to proceed.</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="company-select" class="block text-sm font-medium text-slate-600 mb-1">Company Name</label>
                        <select id="company-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                            <option value="">Loading companies...</option>
                        </select>
                    </div>
                </div>

                <button id="proceed-btn" class="mt-8 w-full bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150">
                    Proceed to Order
                </button>
                <p id="selection-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </div>
        </div>

        <div id="main-view" class="view">
            <header class="bg-slate-800 shadow-md">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <span class="text-2xl font-bold text-white">Client Portal</span>
                        <div class="flex items-center">
                            <span class="text-sm text-gray-300 mr-4">
                                Ordering for: <strong id="client-company-placeholder" class="font-medium text-white">[Company Name]</strong>
                            </span>
                            <button id="change-company-btn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-150">
                                Change Company
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 flex gap-6">
                
                <nav class="w-56 bg-white p-4 rounded-xl shadow-lg self-start sticky top-6">
                    <ul class="space-y-2">
                        <li>
                            <button class="nav-btn active flex items-center w-full text-left py-3 px-4 rounded-lg font-medium text-sm text-teal-700 bg-teal-50" data-tab="products">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                                </svg>
                                Products
                            </button>
                        </li>
                        <li>
                            <button class="nav-btn flex items-center w-full text-left py-3 px-4 rounded-lg font-medium text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900" data-tab="cart">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                My Cart
                            </button>
                        </li>
                        <li>
                            <button class="nav-btn flex items-center w-full text-left py-3 px-4 rounded-lg font-medium text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900" data-tab="history">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Order History
                            </button>
                        </li>
                    </ul>
                </nav>

                <div class="flex-1">
                    
                    <div id="products-tab-content" class="tab-content active">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-6">
                                <div class="relative">
                                    <input type="text" id="product-search-bar" placeholder="Search for products by name..." class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 pl-10">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <h2 class="text-2xl font-semibold text-slate-800">Product Catalog</h2>
                                <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto pr-4">
                                    <p class="text-slate-500">Loading products...</p>
                                </div>
                            </div>
                            <div class="lg:col-span-1">
                                <div class="bg-white p-4 rounded-xl shadow-lg sticky top-6">
                                    <h3 class="text-lg font-medium text-slate-700 mb-3">Your Current Order</h3>
                                    <div id="cart-items" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                                        <p class="text-slate-500 text-sm">Your cart is empty.</p>
                                    </div>
                                    <div class="border-t border-slate-200 mt-4 pt-4">
                                        <div class="flex justify-between font-semibold text-slate-800 text-lg">
                                            <span>Total:</span>
                                            <span id="cart-total">₹0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="cart-tab-content" class="tab-content bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold text-slate-800 mb-6">Review and Place Your Order</h2>
                        <div id="cart-summary" class="max-w-2xl mx-auto space-y-4">
                            <p class="text-slate-500">Your cart is currently empty. Add products from the 'Products' tab.</p>
                        </div>
                         <div class="max-w-2xl mx-auto mt-6 border-t pt-6">
                            <div class="flex justify-between font-bold text-slate-800 text-xl">
                                <span>Grand Total:</span>
                                <span id="cart-summary-total">₹0.00</span>
                            </div>
                            <button id="submit-order-btn" class="mt-6 w-full bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-teal-700 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                                Place Order
                            </button>
                            <p id="order-status-message" class="text-sm mt-4 text-center"></p>
                        </div>
                    </div>

                    <div id="history-tab-content" class="tab-content bg-white p-6 rounded-xl shadow-lg">
                         <h2 class="text-2xl font-semibold text-slate-800 mb-6">Your Order History</h2>
                         <div id="order-history-list" class="space-y-4">
                            <p class="text-slate-500">Loading order history...</p>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = "http://127.0.0.1:5000";
        let currentClient = null;
        let productList = [];
        let cart = [];

        // Element Cache
        const selectionView = document.getElementById('selection-view');
        const mainView = document.getElementById('main-view');
        const companySelect = document.getElementById('company-select');
        const proceedBtn = document.getElementById('proceed-btn');
        const changeCompanyBtn = document.getElementById('change-company-btn');
        const selectionError = document.getElementById('selection-error');
        const productSearchBar = document.getElementById('product-search-bar');
        const clientCompanyPlaceholder = document.getElementById('client-company-placeholder');
        const productListContainer = document.getElementById('product-list');
        const submitOrderBtn = document.getElementById('submit-order-btn');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const cartSummaryContainer = document.getElementById('cart-summary');
        const cartSummaryTotalEl = document.getElementById('cart-summary-total');
        const orderStatusMessage = document.getElementById('order-status-message');

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        async function initializeApp() {
            try {
                const response = await fetch(`${API_BASE_URL}/clients`);
                if (!response.ok) throw new Error('Could not fetch company list.');
                const clients = await response.json();
                
                companySelect.innerHTML = '<option value="">-- Select a Company --</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.client_id;
                    option.textContent = client.company_name;
                    companySelect.appendChild(option);
                });
            } catch (error) {
                companySelect.innerHTML = `<option value="">${error.message}</option>`;
                proceedBtn.disabled = true;
            }
        }

        async function handleProceed() {
            const selectedClientId = companySelect.value;
            selectionError.textContent = '';

            if (!selectedClientId) {
                selectionError.textContent = 'Please select a company.';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/clients/${selectedClientId}`);
                if (!response.ok) throw new Error('Could not fetch client details.');
                
                currentClient = await response.json();
                clientCompanyPlaceholder.textContent = currentClient.company_name;
                
                cart = [];
                updateCartDisplay();
                orderStatusMessage.textContent = '';

                showView('main-view');
                setupTabs();
                // Click the first nav button by default
                document.querySelector('.nav-btn[data-tab="products"]').click();
                fetchAndDisplayProducts();
                fetchAndDisplayOrderHistory();

            } catch (error) {
                selectionError.textContent = `Error: ${error.message}`;
            }
        }

        function handleChangeCompany() {
            currentClient = null;
            companySelect.value = '';
            showView('selection-view');
        }

        function renderProducts(productsToRender) {
            productListContainer.innerHTML = '';
            if (productsToRender.length === 0) {
                productListContainer.innerHTML = `<p class="text-slate-500 col-span-full">No products match your search.</p>`;
                return;
            }

            productsToRender.forEach(product => {
                const price = parseFloat(product.price);
                const placeholderImage = 'https://via.placeholder.com/300x200.png?text=No+Image';

                const productCard = `
                    <div class="bg-white border border-slate-200 rounded-lg p-4 flex flex-col shadow-sm transition-all hover:shadow-md">
                        <img src="${product.image_url || placeholderImage}" alt="${product.name}" class="w-full h-32 object-cover rounded-md mb-4 bg-slate-200">
                        <h3 class="text-md font-bold text-slate-800">${product.name}</h3>
                        <p class="text-sm text-slate-500 flex-grow mt-1">${product.description || 'No description available.'}</p>
                        <div class="mt-4 flex justify-between items-center">
                            <span class="text-lg font-semibold text-slate-700">₹${price.toFixed(2)}</span>
                            <span class="text-sm font-medium ${product.stock_quantity > 10 ? 'text-green-600' : 'text-orange-500'}">
                                ${product.stock_quantity} in stock
                            </span>
                        </div>
                        <button onclick="addToCart(${product.product_id})" class="add-to-cart-btn mt-4 w-full bg-teal-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-teal-700 transition duration-150">
                            Add to Cart
                        </button>
                    </div>
                `;
                productListContainer.insertAdjacentHTML('beforeend', productCard);
            });
        }
        
        function handleProductSearch() {
            const searchTerm = productSearchBar.value.toLowerCase();
            const filteredProducts = productList.filter(p => p.name.toLowerCase().includes(searchTerm));
            renderProducts(filteredProducts);
        }

        async function fetchAndDisplayProducts() {
            productListContainer.innerHTML = `<p class="text-slate-500 col-span-full">Loading products...</p>`;
            try {
                const response = await fetch(`${API_BASE_URL}/products`);
                if (!response.ok) throw new Error('Failed to fetch products');
                productList = await response.json();
                renderProducts(productList);
                productSearchBar.value = '';
            } catch (error)
 {
                productListContainer.innerHTML = `<p class="text-red-500 col-span-full">Error loading products: ${error.message}</p>`;
            }
        }

        async function fetchAndDisplayOrderHistory() {
            const historyContainer = document.getElementById('order-history-list');
            historyContainer.innerHTML = `<p class="text-slate-500">Loading order history...</p>`;
            if (!currentClient) return;

            try {
                const response = await fetch(`${API_BASE_URL}/clients/${currentClient.client_id}/orders`);
                if(!response.ok) throw new Error('Failed to fetch order history.');
                const orders = await response.json();
                historyContainer.innerHTML = '';

                if (orders.length === 0) {
                    historyContainer.innerHTML = `<p class="text-slate-500">You have not placed any orders yet.</p>`;
                    return;
                }
                orders.sort((a, b) => new Date(b.order_date) - new Date(a.order_date));
                orders.forEach(order => {
                    const orderDate = new Date(order.order_date).toLocaleDateString();
                    const orderCard = `
                        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm text-slate-500">Order #${order.order_id}</p>
                                    <p class="text-lg font-semibold text-slate-800">₹${parseFloat(order.total_amount).toFixed(2)}</p>
                                </div>
                                <div class="text-right">
                                     <p class="text-sm text-slate-500">${orderDate}</p>
                                     <span class="text-xs font-semibold px-2 py-1 rounded-full ${order.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                        ${order.status}
                                     </span>
                                </div>
                            </div>
                        </div>
                    `;
                    historyContainer.insertAdjacentHTML('beforeend', orderCard);
                });
            } catch(error) {
                historyContainer.innerHTML = `<p class="text-red-500">Error loading order history: ${error.message}</p>`;
            }
        }

        function addToCart(productId) {
            const product = productList.find(p => p.product_id === productId);
            if (!product || product.stock_quantity <= 0) return;
            const existingItem = cart.find(item => item.product_id === productId);
            if (existingItem) {
                if (existingItem.quantity < product.stock_quantity) existingItem.quantity++;
            } else {
                cart.push({product_id: product.product_id, name: product.name, price: parseFloat(product.price), quantity: 1});
            }

            const button = document.querySelector(`button[onclick="addToCart(${productId})"]`);
            if (button) {
                button.innerHTML = 'Added ✓';
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                button.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                button.disabled = true;

                setTimeout(() => {
                    button.innerHTML = 'Add to Cart';
                    button.classList.remove('bg-green-600', 'hover:bg-green-700');
                    button.classList.add('bg-teal-600', 'hover:bg-teal-700');
                    button.disabled = false;
                }, 1500);
            }
            
            updateCartDisplay();
        }

        function updateCartDisplay() {
            cartItemsContainer.innerHTML = '';
            cartSummaryContainer.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                const emptyMsg = '<p class="text-slate-500 text-sm">Your cart is empty.</p>';
                cartItemsContainer.innerHTML = emptyMsg;
                cartSummaryContainer.innerHTML = emptyMsg;
                submitOrderBtn.disabled = true;
            } else {
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    // *** NEW UI: Added border to cart summary items ***
                    const cartItemHTML = (isSummary) => `
                        <div class="flex justify-between items-center text-sm ${isSummary ? 'bg-white p-3 rounded-lg border border-slate-200' : ''}">
                            <div>
                                <p class="font-medium text-slate-800">${item.name}</p>
                                <p class="text-slate-500">₹${item.price.toFixed(2)} x ${item.quantity} = ₹${itemTotal.toFixed(2)}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" value="${item.quantity}" min="1" onchange="handleQuantityChange(${item.product_id}, this.value)" class="w-16 border rounded-md px-2 py-1 text-center">
                                <button onclick="removeFromCart(${item.product_id})" class="text-red-500 hover:text-red-700 font-bold text-lg leading-none">×</button>
                            </div>
                        </div>
                    `;
                    cartItemsContainer.insertAdjacentHTML('beforeend', cartItemHTML(false));
                    cartSummaryContainer.insertAdjacentHTML('beforeend', cartItemHTML(true));
                });
                submitOrderBtn.disabled = false;
            }
            const totalString = `₹${total.toFixed(2)}`;
            cartTotalEl.textContent = totalString;
            cartSummaryTotalEl.textContent = totalString;
        }

        function handleQuantityChange(productId, newQuantity) {
            const item = cart.find(item => item.product_id === productId);
            const product = productList.find(p => p.product_id === productId);
            const quantity = parseInt(newQuantity, 10);
            if (item && quantity > 0 && quantity <= product.stock_quantity) {
                item.quantity = quantity;
            } else if (item && quantity > product.stock_quantity) {
                item.quantity = product.stock_quantity;
            } else if (item) {
                removeFromCart(productId);
            }
            updateCartDisplay();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.product_id !== productId);
            updateCartDisplay();
        }

        async function submitOrder() {
            submitOrderBtn.disabled = true;
            submitOrderBtn.textContent = 'Placing Order...';
            orderStatusMessage.textContent = '';
            orderStatusMessage.classList.remove('text-green-600', 'text-red-600');
            const orderPayload = {
                client_id: currentClient.client_id,
                items: cart.map(item => ({ product_id: item.product_id, quantity: item.quantity }))
            };
            try {
                const response = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderPayload),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to place order.');
                }
                const result = await response.json();
                orderStatusMessage.textContent = `Success! Order #${result.order_id} has been placed.`;
                orderStatusMessage.classList.add('text-green-600');
                cart = [];
                updateCartDisplay();
                fetchAndDisplayProducts();
                fetchAndDisplayOrderHistory();
            } catch (error) {
                orderStatusMessage.textContent = `Error: ${error.message}`;
                orderStatusMessage.classList.add('text-red-600');
                submitOrderBtn.disabled = false;
            } finally {
                submitOrderBtn.textContent = 'Place Order';
            }
        }

        // *** NEW UI: Updated JS to use '.nav-btn' and new active classes ***
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.nav-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Reset all buttons
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'bg-teal-50', 'text-teal-700');
                        btn.classList.add('text-gray-600', 'hover:bg-gray-100', 'hover:text-gray-900');
                    });
                    // Hide all content
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Set active button
                    button.classList.add('active', 'bg-teal-50', 'text-teal-700');
                    button.classList.remove('text-gray-600', 'hover:bg-gray-100', 'hover:text-gray-900');
                    
                    // Show active content
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab-content`).classList.add('active');
                    
                    if (tabId === 'history') {
                        fetchAndDisplayOrderHistory();
                    }
                });
            });
        }
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', initializeApp);
        proceedBtn.addEventListener('click', handleProceed);
        changeCompanyBtn.addEventListener('click', handleChangeCompany);
        submitOrderBtn.addEventListener('click', submitOrder);
        productSearchBar.addEventListener('keyup', handleProductSearch);

    </script>
</body>
</html>